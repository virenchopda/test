import 'package:googleapis_auth/auth_io.dart' as auth;
import 'package:agora_rtc_engine/agora_rtc_engine.dart';

const channelName = 'TestChannelName';
const appId = '6f50e7f7be3840a1b8882eeeaa97f272';
const tempToken =
    '007eJxTYPiY6xQUW2V+sZ7bYIdj8KFJyrOfWGqsm61r2ln6pzP3wQMFBrM0U4NU8zTzpFRjCxODRMMkCwsLo9TU1MRES/M0I3OjHFvLzIZARoYg6+WMjAysDIwMTAwgPgMDAHAhHPc=';

  Future<void> sendIncomingCallNotification() async {
    final serviceAccountJson = {
      "type": "service_account",
      "project_id": "e-book-learning-online",
      "private_key_id": "",
      "private_key": "",
      "client_email": "",
      "client_id": "103736509778503571815",
      "auth_uri": "https://accounts.google.com/o/oauth2/auth",
      "token_uri": "https://oauth2.googleapis.com/token",
      "auth_provider_x509_cert_url":
          "https://www.googleapis.com/oauth2/v1/certs",
      "client_x509_cert_url":
          "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-f9ga3%40e-book-learning-online.iam.gserviceaccount.com",
      "universe_domain": "googleapis.com",
    };

    final credentials = auth.ServiceAccountCredentials.fromJson(
      serviceAccountJson,
    );

    final scopes = ['https://www.googleapis.com/auth/firebase.messaging'];

    final access = await auth.obtainAccessCredentialsViaServiceAccount(
      credentials,
      scopes,
      http.Client(),
    );

    print("Access Token: ${access.accessToken.data}");

   final url = Uri.parse(
      "https://fcm.googleapis.com/v1/projects/$projectId/messages:send",
    );

    final message = {
      "message": {
        "token": NotificationDevice.deviceToken,
        "notification": {"title": 'Incoming call....', "body": 'Someone is calling you...'},
        "data": {"type": "incoming_call", "channelName": channelName},
      },
    };

    final response = await http.post(
      url,
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer ${access.accessToken.data}",
      },
      body: jsonEncode(message),
    );

    print("FCM RESPONSE: ${response.statusCode}  ${response.body}");
  }

